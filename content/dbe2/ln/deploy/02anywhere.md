+++
title = "PythonAnywhere"
description = ""
weight = 2
alwaysopen = true
+++

PythonAnywhereを使った実習を行う．
前節で紹介した模擬図書館アプリケーションを
インターネットからアクセスできるようにデプロイを行ってみる．

## アカウントの取得

実習には 
[PythonAnywhere](https://www.pythonanywhere.com)
でアカウントが必要である．無料アカウントの範囲で実施できる．

* [Plans and pricing](https://www.pythonanywhere.com/pricing/)
  のページで，Create a Beginner account ボタンを押し，
  必要事項を記入して登録する．
* 機能紹介ツアーが始まる．見ても良いし，End Tour を押してスキップしても良い．
* PythonAnywhere からメールが届くので，
  本文中のリンクをクリックして，メールアドレスを確認する．

## ウェブアプリケーション環境の作成

Dashboard 右上にあるリンクのうち Web をクリックすると，
ウェブアプリケーション環境の画面になる．

* Add a new web app ボタンをクリックする．
* domain name については，単に Next ボタンを押す．
* Python Web framework では，Flask を選択する．
* Python version はどれでも良いように思うが，一応，Python3.9を選択しておく．
* Quickstart Flask project では，デフォルトのパス名
  `.../mysite/flask_app.py` を受け入れる

これで，Hello World のアプリケーションが作成されている．
`https://ユーザ名.pythonanywhere.com/` にアクセスしてみよ．

生成された (Dashboard の Web をクリックすると現れる) Configuration 
のページを一通り見ておくと良い．とくに，賞味期限 (Best before date) 
のところを読んでおくこと．

## 模擬図書館アプリケーションの展開

動作している模擬図書館アプリケーションのファイル一式を，1つの zip ファイルに
まとめる．授業で配布したzipファイルそのものでも良いのだが，
練習12-1 で各自機能拡張をしているわけだから，その拡張したものを
デプロイしてみよう．

PythonAnywhere の Dashboard で，Files を選ぶ．左側のディレクトリ一覧にある
mysite をクリックする．
現在は，ここに flask_app.py というファイルが1つだけ有るはずである．
Upload a file というボタンを押して，
このディレクトリに，上で作成した zip ファイルをアップロードする．

アップロードした zip ファイルを展開するには，コンソールを使う必要が
ある．bash コンソールが準備されている．

* PythonAnywhere メニューの Consoles をクリックする．
* 現れたページで，上の方にある Bash をクリックする．
* command prompt のような配色の画面が現れる．以下のように入力すると，
  README.txt と mysite がリストされるはずである．
  コマンド `ls -l` は，Windows の command.com における `dir` コマンドの
  ようなものである．

```
ls -l
```

* 以下のように入力する．flask_app.py とともに，自分がアップロードした
  zip ファイルがリストされていることを確認する．

```
cd mysite
ls -l
```

* 次のように入力する (もちろん，「zipファイル名」のところは，
自分がアップロードしたzipファイル名に置き換える)．

```
unzip -l zipファイル名
```

* zip ファイルの内容がリストされる．
  `mlib.py` が入っているはずだが，これが，カレントディレクトリに
  展開されることを確認する．つまり，「良い例」 のように，ファイル名が
  単独で表示されていること．「悪い例」 のように，ファイル名の前に
  ディレクトリ名がついていないことを確認する．「悪い例」 のようになっていたら，
  zip ファイルを作り直す．
  
良い例
```
  Length      Date    Time    Name
---------  ---------- -----   ----
     4665  2021-06-08 12:17   mlib.py
      195  2021-06-08 12:21   static/html/example.html
      ........(以下略).....
```

悪い例
```
  Length      Date    Time    Name
---------  ---------- -----   ----
     4665  2021-06-08 12:17   myapp/mlib.py
      195  2021-06-08 12:21   myapp/static/html/example.html
      ........(以下略).....
```

* 以下のコマンドを実行すると，実際にファイルが展開される．

```
unzip zipファイル名
```

* 右上の「≡」ボタンのメニューから Dashboard を選ぶ．


## データベースの移行

模擬図書館アプリケーションを動かすには，
当然，MySQLサーバが必要である．
幸いなことに，PythonAnywhere は，MySQLサーバも提供している．

* PythonAnywhere のメニューで，Databases をクリックする．
* データベースアクセス用のパスワードを決めて，登録する．
    * パスワードはメモしておくこと (注1)
    * このパスワードは，平文でソースコードに書き込むので，
      他の重要なパスワードと同じものを使ってはいけない．
    * もちろん，本当は平文でソースコードに書き込むのも避けるべきであり，
      避ける方法はあるが，ここでは面倒なので省略する．
* MySQL setting として，設定が表示される．

ここに，模擬図書館アプリケーションで使用するテーブルを作成しなければ
ならない．ローカルマシンで動作しているテーブルから移行する．

* ローカルマシンで phpMyAdmin を起動して，次の3つのテーブルの
  バックアップファイルを作成する．(1テーブルについて1つずつファイルが
  できる．
  * 利用者
  * 書籍
  * 貸出
* バックアップファイル名は何でも良いのだが，
  日本語を使わない方が無難である．ここでは，順に `file1.sql`, 
  `file2.sql`, `file3.sql` としたとする．
* 3つのファイルを PythonAnywhere にアップロードする．
  先ほどと同じように (実はあまり感心しないが，まあ面倒なので，) 
  mysite ディレクトリにアップロードする．
* Consoles 画面に移動する．MySQL をクリックする．
* 次のように入力することで，ファイルのインポートが行える．
  ファイル名は自分で付けたものに置き換える．
  ___貸出テーブルのファイルが最後に実行されるようにすること___．

```
source mysite/file1.sql
source mysite/file2.sql
source mysite/file3.sql
```

* だいたい，`Query OK, xxx rows affected` といったような表示が並んでいれば
  OKである．0 rows という行が多い．

## アプリケーションの書き換え

PythonAnywhere が自動で生成したファイルの書き換えを行う

* PythonAnywhere の Web メニューのページを表示する．
* 中央付近の Code というセクションに WSGI configuration file
  という項目がある．その右側の `/var/..._wsgi.py` というリンクをクリックする．
  ファイル編集画面になる．
* 最下行の `flask_app` という部分を `mlib` に書き換える．
* Save ボタンを押す．
* 右上の「≡」メニューから Dashboard に戻る．

次に，`mlib.py` を，この環境に合わせて書き換える．

* Files 画面で，mysite ディレクトリを選び，mlib.py をクリックする．
  編集画面になる．
* 関数 `connect_db` で指定しているパラメタの値を変更する．
    * host ... Databases 画面で，Database host address に表示されている値
      (`ユーザ名.mysql.pythonanywhere-services.com` 
       といった値になっていると思われる)
    * user ... Databases 画面で，Username に表示されている値
    * passwd ... MySQL設定時 (上記「(注1)」) に登録した値
    * db ... Databases 画面で，Start a console on に表示されている値
      (`ユーザ名$default` といった値になっていると思われる)
* 最終行 `app.run(...)` を削除する．
* Save ボタンを押す．

## アプリケーションの再起動

以上で編集は終了である．
Web 画面で一番上にある緑色の
Reload xxx.pythonanywhere.com ボタンを押して，
ウェブアプリケーションを再起動する．

flask の付属ウェブサーバでは，ソースコードを書き直すと自動的に
再読込が行われ，変更が反映されていた (開発に便利な機能)．
運用フェーズで用いるサーバは，通常そのような機能を持っていない
(性能面で不利になるから)．

`https://ユーザ名.pythonanywhere.com/` にアクセスして，
模擬図書館アプリケーションが動作しているかどうか調べてみよ．
たとえば，スマートフォンなどからアクセスを行ってみることで，
たしかにインターネット上にアプリケーションが展開できているということを
確認されたい．

動作しない場合，Web 画面の下の方にある Log files のリンクから
表示されるログ情報が役に立つ可能性がある．

## ファイルの管理

今回は，zipファイルを作成してファイルの移行を行った．
1回や2回であれば，この手順でも良いが，新たな機能を作る時や，
問題点の修正を行ったときに，いちいちファイルをアップロードするのは
手間である．サーバ上のファイルを直接書き直すのは，ファイル管理上
問題がある
(すぐにローカルマシンのファイルとの非整合が生じて混乱する)．

今日では，多くの開発者は，
[Git](https://git-scm.com/) という
ファイル管理システムを利用している．
特に，複数人で開発を行うときに有意義であるが，このように
運用環境と開発環境が異なる場合には，一人で開発を行っていても
有用なツールである．

* ローカルマシンには，
  [Git のクライアントプログラム](https://git-scm.com/downloads)
  をインストールする．
* インターネット上に，[GitHub](https://github.com) というサービスが
  あるので，アカウントを作成する．
* 開発する単位で「リポジトリ」を GitHub 上で作成する．
* GitHub上のリポジトリと，ローカルマシンのディレクトリを関連付ける．
* ローカルマシン上でファイルを編集し，ひとわたりの確認を行ったら，
  変更をGitHub に「push」する(そういうコマンドがある)．
* Pythonanywhere でも，ディレクトリを同じリポジトリに関連付けておき，
  GitHub に上げられた変更を「pull」する(そういうコマンドがある)．

このような手順を取ることで，ローカルマシンで開発・テストをしたコードを，
デプロイ環境に簡単に反映させることができるようになる．
(Git の使い方を覚えなくてはならないのが大変だが，
きょうびのソフトウェア開発者にとっては常識に属することなので，
勉強する価値はある．)

## おわりに

PythonAnywere を使って模擬図書館アプリケーションを
デプロイした．

PythonAnywhere の無料アカウント枠は，
小さなアプリケーションを運用するには十分であるが，
当然，様々な制約がある．
学科の活動や卒業研究などで大規模なアプリケーションを作成したり，
フレキシブルな運用を行いたい場合には，Linux マシンを利用して，
ウェブサーバなども自分で設定を行って運用する方法の方が適している場合もある．
そのような環境の用意もあるので，必要な場合には相談されたい．

